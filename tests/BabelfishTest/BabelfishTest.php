<?php

declare(strict_types=1);

namespace BabelfishTest;

use Babelfish\Babelfish;
use Babelfish\File\ContentFile;
use Babelfish\File\SourceFile;
use Babelfish\Language;
use Babelfish\Strategy\Strategy;
use PHPUnit\Framework\TestCase;

class BabelfishTest extends TestCase
{
    private const INCORRECT_CLASSIFICATION = [
        'Git Commit.JSON-tmLanguage' => NULL,
        'videodb.ddl' => NULL,
        'AvailableInSearchSel.prc' => NULL,
        'hostcache_set_state.inc' => NULL,
        'benchmark_nbody.t' => 'Perl',
        'arith.t' => 'Perl 6',
        'arrayt.t' => 'Perl',
        'manos.spec' => NULL,
        'erlang-erlydtl.spec' => NULL,
        'apache.spec' => NULL,
        'ciaaConector.sch' => NULL,
        'buttons.sch' => NULL,
        'gedda-junk.sch' => NULL,
        'Volume.sch' => NULL,
        'ultimate-temp-controller.sch' => NULL,
        'buzzer.sch' => NULL,
        'sounds.properties' => 'INI',
        'libraries.properties' => 'INI',
        'stages-example.pp' => NULL,
        'hiera_include.pp' => NULL,
        'Foo.ML' => 'OCaml',
        'op4.j' => NULL,
        'op3.j' => NULL,
        'if4.j' => NULL,
        'if1.j' => NULL,
        'if2.j' => NULL,
        'op1.j' => NULL,
        'if3.j' => NULL,
        'op2.j' => NULL,
        'sboyer.sch' => NULL,
        'lambdastar.sls' => NULL,
        'JsNumber.v' => NULL,
        'Imp.v' => NULL,
        'Stlc.v' => NULL,
        'Lists.v' => NULL,
        'Computation.v' => NULL,
        'JsCorrectness.v' => NULL,
        'Rel.v' => NULL,
        'Poly.v' => NULL,
        'Spec.v' => NULL,
        'Smallstep.v' => NULL,
        'JsPrettyInterm.v' => NULL,
        'Main.v' => NULL,
        'JsInterpreterExtraction.v' => NULL,
        'MolecularClock.bf' => NULL,
        'CodonModelCompare.bf' => NULL,
        'profile_test.bf' => NULL,
        'dNdSDistributionComparison.bf' => NULL,
        'MFPositiveSelection.bf' => NULL,
        'MatrixIndexing.bf' => NULL,
        'AAModelComparison.bf' => NULL,
        'hyphy_cmds.bf' => NULL,
        'tc14badge.brd' => NULL,
        'macros.inc' => NULL,
        'fp_sqr32_160_comba.inc' => NULL,
        'lib.inc' => NULL,
        'TUITableView.h' => 'C++',
        'MainMenuViewController.h' => 'C++',
        'Siesta.h' => 'C++',
        'ASIHTTPRequest.h' => 'C++',
        'JSONKit.h' => 'C++',
        'interface.h' => 'C++',
        'GLKMatrix4.h' => 'C++',
        'bitmap.h' => 'C++',
        'bootstrap.h' => 'C++',
        'elf.h' => 'C++',
        'http_parser.h' => 'C++',
        'syscalls.h' => 'C++',
        'driver.h' => 'C++',
        'asm.h' => 'C++',
        'portio.h' => 'C++',
        'syscalldefs.h' => 'C++',
        'rf_io.h' => 'C++',
        'rfc_string.h' => 'C++',
        'pqiv.h' => 'C++',
        'ip4.h' => 'C++',
        'NWMan.h' => 'C++',
        'cpuid.h' => 'C++',
        'commit.h' => 'C++',
        'ntru_encrypt.h' => 'C++',
        'hello.h' => 'C++',
        'info.h' => 'C++',
        'multiboot.h' => 'C++',
        'scheduler.h' => 'C++',
        'vmem.h' => 'C++',
        'exception.zep.h' => 'C++',
        'color.h' => 'C++',
        'jni_layer.h' => 'C++',
        'blob.h' => 'C++',
        'Nightmare.h' => 'C++',
        '2D.H' => 'C++',
        'wglew.h' => 'C++',
        'filter.h' => 'C++',
        'ArrowLeft.h' => 'C++',
        'vfs.h' => 'C++',
        'array.h' => 'C++',
        'recurse1.frag' => NULL,
        'SyLens.shader' => NULL,
        'SimpleLighting.gl2.frag' => NULL,
        'islandScene.shader' => NULL,
        'cc-public_domain_mark_white.pm' => 'Perl',
        'run' => NULL,
        'js' => NULL,
        'outro.js.frag' => NULL,
        'chart_composers.gs' => NULL,
        'intro.js.frag' => NULL,
        'itau.gs' => NULL,
        'js2' => NULL,
        'cnokw.re' => NULL,
        'instances.inc' => NULL,
        'program.cp' => NULL,
        'ClasspathVMSystemProperties.inc' => NULL,
        'bug1163046.--skeleton.re' => NULL,
        'initClasses.inc' => NULL,
        'cvsignore.re' => NULL,
        'bar.hh' => NULL,
        'simple.re' => NULL,
        'Magic.gd' => NULL,
        'PackageInfo.g' => NULL,
        'example.gd' => NULL,
        'vspc.gd' => NULL,
        'matlab_class.m' => 'Objective-C',
        'normalize.m' => 'Objective-C',
        'Check_plot.m' => 'Objective-C',
        'Example.cp' => NULL,
        'prefix.fcgi' => NULL,
        'rot13.bf' => NULL,
        'helloworld.bf' => NULL,
        'hello.bf' => NULL,
        'fib100.bf' => NULL,
        'factor.b' => NULL,
        'grid.gd' => NULL,
        'player.gd' => NULL,
        'pong.gd' => NULL,
        'hex_display.v' => NULL,
        'sha-256-functions.v' => NULL,
        'sign_extender.v' => NULL,
        'button_debounce.v' => NULL,
        'ps2_mouse.v' => NULL,
        't_button_debounce.v' => NULL,
        'control.v' => NULL,
        'mux.v' => NULL,
        't_div_pipelined.v' => NULL,
        't_sqrt_pipelined.v' => NULL,
        'vga.v' => NULL,
        'pipeline_registers.v' => NULL,
        'sqrt_pipelined.v' => NULL,
        'mbittorrent.fx' => NULL,
        'test.fx' => NULL,
        'imageserver.fx' => NULL,
        'gameserver.fx' => NULL,
        'example.com.vhost' => NULL,
        'haproxy2.cfg' => NULL,
        'haproxy4.cfg' => NULL,
        'haproxy3.cfg' => NULL,
        'fixed.inc' => NULL,
        'y_testing.inc' => NULL,
        'mfile.inc' => NULL,
        'Check.inc' => NULL,
        'PacletInfo.m' => 'Objective-C',
        'MiscCalculations2.nb' => NULL,
        'MiscCalculations.nb' => NULL,
        'Problem12.m' => 'Objective-C',
        'cApplication.cls' => NULL,
        'build.cake' => NULL,
        'EventHandlerMac.mm' => NULL,
        'objsql.mm' => NULL,
        'Uber.shader' => NULL,
        'Fog.shader' => NULL,
        'DepthOfField.shader' => NULL,
        'vmops_impl.inc' => NULL,
        'image_url.inc' => NULL,
        'libc.inc' => NULL,
        'HelloWorld.as' => 'AngelScript',
        'FooBar.as' => 'AngelScript',
        'Regex.mqh' => NULL,
        'check_reorg.sql' => 'SQL',
        'sleep.sql' => 'SQL',
        'runstats.sql' => 'SQL',
        'Class.gs' => NULL,
        'Hello.gs' => NULL,
        'header-sample.mqh' => NULL,
        'print_bool.prc' => NULL,
        'func.pl' => 'Perl',
        'format_spec.pl' => 'Perl',
        'admin.pl' => 'Perl',
        'BooleanUtils.cls' => NULL,
        'ArrayUtils.cls' => NULL,
        'LanguageUtils.cls' => NULL,
        'GeoUtils.cls' => NULL,
        'EmailUtils.cls' => NULL,
        'TwilioAPI.cls' => NULL,
        'hello.moo' => NULL,
        'moocode_toolkit.moo' => NULL,
        'toy.moo' => NULL,
        'Machine.re' => NULL,
        'Syntax.re' => NULL,
        'SuperMerlin.re' => NULL,
        'JSX.re' => NULL,
        'Layout.re' => NULL,
        'pdp10.md' => 'Markdown',
        'HITSP_C32.sch' => NULL,
        'oasis-table.sch' => NULL,
        'XmlIO.pluginspec' => NULL,
        'Case.workflow' => NULL,
        'some-ideas.mm' => NULL,
        'namespace-strict.sch' => NULL,
        'list.m4' => NULL,
        'ax_ruby_devel.m4' => NULL,
        'linguist.srt' => NULL,
        'long_seq.for' => 'Fortran',
        'wksst8110.for' => 'Fortran',
        'Util.cls' => NULL,
        'Email.cls' => NULL,
        'SendEmailAlgorithm.cls' => NULL,
        'tailDel.inc' => NULL,
        'rpanel.inc' => NULL,
        'ApiOverviewPage.st' => NULL,
        'fixes.inc' => NULL,
        'spec.linux.spec' => NULL,
        'main.workflow' => NULL,
        'Eagle.brd' => NULL,
        'Eagle.sch' => NULL,
        'duettest.g' => NULL,
        'square.g' => NULL,
        'LightsOff.j' => NULL,
        'AppController.j' => NULL,
        'iTunesLayout.j' => NULL,
        'top.sls' => NULL,
        'openoffice.sls' => NULL,
        'gpg4win-light.sls' => NULL,
        'gimp.sls' => NULL,
        'eval.sls' => NULL,
        'truecrypt.sls' => NULL,
        'jellyfish.fx' => NULL,
        'corridor.fx' => NULL,
        'noise.fx' => NULL,
        'ms.cfg' => NULL,
        'ifelse.m' => 'Objective-C',
        'forloop.m' => 'Objective-C',
        'arrays.m' => 'Objective-C',
        'fibonacci.m' => 'Objective-C',
        'indirectfunctions.m' => 'Objective-C',
        'mileage.m' => 'Objective-C',
        'helloworld.m' => 'Objective-C',
        'nesting.m' => 'Objective-C',
        'scriptWithPragma.st' => NULL,
        'testSimpleChainMatches.st' => NULL,
        'Dinner.st' => NULL,
        'smallMethod.st' => NULL,
        'baselineDependency.st' => NULL,
        'renderSeasideExampleOn..st' => NULL,
        'TestBasic.st' => NULL,
        'categories.st' => NULL,
        'aptitude-defaults.nb' => NULL,
        'tutor.nb' => NULL,
        'LIDARLite.ncl' => NULL,
        'example.ch' => NULL,
        'Hacl.HKDF.fst' => 'F*',
        'Hacl.Spec.Bignum.Fmul.fst' => 'F*',
        'expr.moo' => NULL,
        'string1.x' => NULL,
        'htmlgen.m4' => NULL,
        'jenkinsci.pluginspec' => NULL,
        'any.spec' => NULL,
        'feedgnuplot' => NULL,
        'perl' => NULL,
        'Functions.E' => 'Eiffel',
        'minChat.E' => 'Eiffel',
        'Extends.E' => 'Eiffel',
        'Promises.E' => 'Eiffel',
        'IO.E' => 'Eiffel',
        'Guards.E' => 'Eiffel',
        'gsn_csm_xy2_time_series_inputs.ncl' => NULL,
        'weather_sym_6.ncl' => NULL,
        'WRF_track_1.ncl' => NULL,
        'WRF_static_2.ncl' => NULL,
        'viewport_4.ncl' => NULL,
        'hdf4sds_7.ncl' => NULL,
        'PrnOscPat_driver.ncl' => NULL,
        'traj_3.ncl' => NULL,
        'unique_9.ncl' => NULL,
        'primero.ncl' => NULL,
        'mcsst_1.ncl' => NULL,
        'cru_8.ncl' => NULL,
        'topo_9.ncl' => NULL,
        'mask_12.ncl' => NULL,
        'xy_29.ncl' => NULL,
        'tsdiagram_1.ncl' => NULL,
        'lock.b' => NULL,
        'lock.m' => 'Objective-C',
        'cat.b' => NULL,
        'apache.vhost' => NULL,
        'inject.x' => NULL,
    ];

    public function testGetLanguage(): void
    {
        $babelfish = Babelfish::getWithDefaultStrategies();

        $directory = new \RecursiveDirectoryIterator(__DIR__ . '/../../linguist/samples/', \RecursiveDirectoryIterator::SKIP_DOTS);
        $iterator = new \RecursiveIteratorIterator($directory);
        foreach ($iterator as $sample_file) {
            if (array_key_exists($sample_file->getFilename(), self::INCORRECT_CLASSIFICATION)) {
                continue;
            }

            $expected_language_name = basename($sample_file->getPath());
            if ($expected_language_name === 'filenames') {
                $expected_language_name = basename(dirname($sample_file->getPath()));
            }
            $source_file = new ContentFile($sample_file->getFilename(), file_get_contents($sample_file->getPathname()));
            $language = $babelfish->getLanguage($source_file);

            $this->assertNotNull($language);
            $this->assertEquals($expected_language_name, $language->getName());
        }
    }
}
